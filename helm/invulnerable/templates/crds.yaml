---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.0
  name: imagescans.invulnerable.io
spec:
  group: invulnerable.io
  names:
    kind: ImageScan
    listKind: ImageScanList
    plural: imagescans
    shortNames:
    - imgscan
    - imgscans
    singular: imagescan
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.image
      name: Image
      type: string
    - jsonPath: .spec.schedule
      name: Schedule
      type: string
    - jsonPath: .spec.suspend
      name: Suspend
      type: boolean
    - jsonPath: .status.cronJobName
      name: CronJob
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: ImageScan is the Schema for the imagescans API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: ImageScanSpec defines the desired state of ImageScan
            properties:
              apiEndpoint:
                description: |-
                  APIEndpoint is the Invulnerable backend API endpoint
                  If not specified, it will be auto-detected from the service
                type: string
              failedJobsHistoryLimit:
                default: 3
                description: FailedJobsHistoryLimit is the number of failed jobs to
                  retain
                format: int32
                minimum: 0
                type: integer
              image:
                description: Image is the container image to scan (e.g., "nginx:latest",
                  "myregistry.io/app:1.0.0")
                minLength: 1
                type: string
              imagePullSecrets:
                description: |-
                  ImagePullSecrets is an optional list of references to secrets in the same namespace
                  to use for pulling the container image from private registries.
                  These secrets should be of type kubernetes.io/dockerconfigjson.
                  See https://kubernetes.io/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod
                items:
                  description: |-
                    LocalObjectReference contains enough information to let you locate the
                    referenced object inside the same namespace.
                  properties:
                    name:
                      default: ""
                      description: |-
                        Name of the referent.
                        This field is effectively required, but due to backwards compatibility is
                        allowed to be empty. Instances of this type with an empty value here are
                        almost certainly wrong.
                        More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                      type: string
                  type: object
                  x-kubernetes-map-type: atomic
                type: array
              onlyFixable:
                default: false
                description: |-
                  OnlyFixable specifies whether to only report vulnerabilities with available fixes.
                  When true, Grype will skip vulnerabilities that have no fix available.
                  Default: false (report all vulnerabilities)
                type: boolean
              registryPolling:
                description: |-
                  RegistryPolling configures automatic scanning when image updates are detected in the registry
                  This is a hybrid approach - both scheduled CronJobs and registry-triggered scans can coexist
                  When enabled, the controller periodically checks the registry for digest changes and triggers immediate scans
                properties:
                  enabled:
                    default: false
                    description: |-
                      Enabled determines if registry polling is active
                      When enabled, the controller will periodically check the registry for new image versions
                      and automatically trigger scans when the image digest changes
                    type: boolean
                  interval:
                    default: 5m
                    description: |-
                      Interval is how often to check the registry for updates
                      Must be at least 1 minute to prevent API rate limiting
                      Default: 5m (5 minutes)
                    type: string
                type: object
              resources:
                description: Resources defines the resource requirements for the scanner
                  job
                properties:
                  claims:
                    description: |-
                      Claims lists the names of resources, defined in spec.resourceClaims,
                      that are used by this container.

                      This field depends on the
                      DynamicResourceAllocation feature gate.

                      This field is immutable. It can only be set for containers.
                    items:
                      description: ResourceClaim references one entry in PodSpec.ResourceClaims.
                      properties:
                        name:
                          description: |-
                            Name must match the name of one entry in pod.spec.resourceClaims of
                            the Pod where this field is used. It makes that resource available
                            inside a container.
                          type: string
                        request:
                          description: |-
                            Request is the name chosen for a request in the referenced claim.
                            If empty, everything from the claim is made available, otherwise
                            only the result of this request.
                          type: string
                      required:
                      - name
                      type: object
                    type: array
                    x-kubernetes-list-map-keys:
                    - name
                    x-kubernetes-list-type: map
                  limits:
                    additionalProperties:
                      anyOf:
                      - type: integer
                      - type: string
                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                      x-kubernetes-int-or-string: true
                    description: |-
                      Limits describes the maximum amount of compute resources allowed.
                      More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
                    type: object
                  requests:
                    additionalProperties:
                      anyOf:
                      - type: integer
                      - type: string
                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                      x-kubernetes-int-or-string: true
                    description: |-
                      Requests describes the minimum amount of compute resources required.
                      If Requests is omitted for a container, it defaults to Limits if that is explicitly specified,
                      otherwise to an implementation-defined value. Requests cannot exceed Limits.
                      More info: https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
                    type: object
                type: object
              sbomFormat:
                default: cyclonedx
                description: SBOMFormat specifies the SBOM format to use (cyclonedx,
                  spdx, etc.)
                enum:
                - cyclonedx
                - spdx
                type: string
              scannerImage:
                description: Scanner image configuration
                properties:
                  pullPolicy:
                    default: IfNotPresent
                    description: PullPolicy is the image pull policy
                    enum:
                    - Always
                    - Never
                    - IfNotPresent
                    type: string
                  repository:
                    default: invulnerable-scanner
                    description: Repository is the image repository
                    type: string
                  tag:
                    default: latest
                    description: Tag is the image tag
                    type: string
                type: object
              schedule:
                description: |-
                  Schedule configures time-based scanning via CronJob
                  If disabled or not specified, only registry polling will trigger scans
                properties:
                  cron:
                    description: |-
                      Cron schedule in cron format for when to run the scan
                      Required if enabled is true
                      Example: "0 2 * * *" (daily at 2 AM)
                    example: 0 2 * * *
                    minLength: 1
                    type: string
                  enabled:
                    default: true
                    description: |-
                      Enabled determines if scheduled scanning via CronJob is active
                      When false, only registry polling (if enabled) will trigger scans
                      Default: true
                    type: boolean
                  suspend:
                    default: false
                    description: |-
                      Suspend temporarily pauses scheduled scans without disabling the schedule
                      When true, the CronJob will not trigger new scans, but registry polling (if enabled) continues
                      Default: false
                    type: boolean
                type: object
              sla:
                description: |-
                  SLA defines Service Level Agreement for vulnerability remediation in days per severity.
                  This configuration is stored with each scan for compliance tracking.
                  If not specified, default SLA values are used: Critical=7, High=30, Medium=90, Low=180
                properties:
                  critical:
                    default: 7
                    description: Critical severity SLA in days
                    minimum: 1
                    type: integer
                  high:
                    default: 30
                    description: High severity SLA in days
                    minimum: 1
                    type: integer
                  low:
                    default: 180
                    description: Low severity SLA in days
                    minimum: 1
                    type: integer
                  medium:
                    default: 90
                    description: Medium severity SLA in days
                    minimum: 1
                    type: integer
                type: object
              successfulJobsHistoryLimit:
                default: 3
                description: SuccessfulJobsHistoryLimit is the number of successful
                  jobs to retain
                format: int32
                minimum: 0
                type: integer
              timeZone:
                description: |-
                  TimeZone for the CronJob schedule (e.g., "America/New_York", "UTC")
                  If not specified, defaults to the system timezone
                type: string
              webhooks:
                description: Webhooks configuration for multiple notification types
                properties:
                  format:
                    default: slack
                    description: |-
                      Format specifies the webhook payload format (slack, teams)
                      This format is used for all notification types
                    enum:
                    - slack
                    - teams
                    type: string
                  scanCompletion:
                    description: ScanCompletion configures notifications sent after
                      each scan completes
                    properties:
                      enabled:
                        default: true
                        description: Enabled allows temporarily disabling scan completion
                          notifications
                        type: boolean
                      minSeverity:
                        default: High
                        description: MinSeverity is the minimum severity level to
                          trigger notifications
                        enum:
                        - Critical
                        - High
                        - Medium
                        - Low
                        - Negligible
                        type: string
                      onlyFixable:
                        default: true
                        description: |-
                          OnlyFixable specifies whether to only send notifications for vulnerabilities with available fixes.
                          When true, unfixable vulnerabilities will not trigger scan completion webhooks.
                          This is independent of the ImageScan's OnlyFixable setting - you can scan all CVEs but only notify for fixable ones.
                          Default: true (only notify for vulnerabilities with fixes)
                        type: boolean
                    type: object
                  secretRef:
                    description: |-
                      SecretRef references a Secret containing the webhook URL
                      The Secret must be in the same namespace as the ImageScan
                      Either URL or SecretRef must be specified, but not both
                    properties:
                      key:
                        description: The key of the secret to select from.  Must be
                          a valid secret key.
                        type: string
                      name:
                        default: ""
                        description: |-
                          Name of the referent.
                          This field is effectively required, but due to backwards compatibility is
                          allowed to be empty. Instances of this type with an empty value here are
                          almost certainly wrong.
                          More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                        type: string
                      optional:
                        description: Specify whether the Secret or its key must be
                          defined
                        type: boolean
                    required:
                    - key
                    type: object
                    x-kubernetes-map-type: atomic
                  statusChange:
                    description: StatusChange configures notifications sent when vulnerability
                      statuses are changed
                    properties:
                      enabled:
                        default: true
                        description: Enabled allows enabling/disabling status change
                          notifications
                        type: boolean
                      includeNoteChanges:
                        default: false
                        description: IncludeNoteChanges determines if note/comment
                          additions trigger notifications
                        type: boolean
                      minSeverity:
                        default: High
                        description: |-
                          MinSeverity is the minimum severity to notify about (Critical, High, Medium, Low, Negligible)
                          Only vulnerabilities at or above this severity will trigger notifications
                        enum:
                        - Critical
                        - High
                        - Medium
                        - Low
                        - Negligible
                        type: string
                      onlyFixable:
                        default: true
                        description: |-
                          OnlyFixable specifies whether to only send notifications for vulnerabilities with available fixes.
                          When true, unfixable vulnerabilities will not trigger status change webhooks.
                          This is independent of the ImageScan's OnlyFixable setting - you can scan all CVEs but only notify for fixable ones.
                          Default: true (only notify for vulnerabilities with fixes)
                        type: boolean
                      statusTransitions:
                        description: |-
                          StatusTransitions filters which status changes trigger notifications
                          Format: "old_status→new_status" (e.g., "active→fixed", "active→ignored")
                          Empty list means notify on all transitions
                          Example: ["active→fixed", "active→ignored", "in_progress→fixed"]
                        items:
                          type: string
                        type: array
                    type: object
                  url:
                    description: |-
                      URL is the webhook endpoint URL used for all notification types
                      Either URL or SecretRef must be specified, but not both
                    minLength: 1
                    pattern: ^https?://.*$
                    type: string
                type: object
              workspaceSize:
                default: 10Gi
                description: |-
                  WorkspaceSize defines the size of the temporary workspace for image extraction
                  This should be larger than the largest image you plan to scan
                  Default: 10Gi (suitable for most images, increase for larger images)
                  WARNING: Multiple ImageScans can run concurrently and consume node disk space
                type: string
            required:
            - image
            type: object
          status:
            description: ImageScanStatus defines the observed state of ImageScan
            properties:
              conditions:
                description: Conditions represent the latest available observations
                  of the ImageScan's state
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              cronJobName:
                description: CronJobName is the name of the managed CronJob
                type: string
              lastCheckedDigest:
                description: |-
                  LastCheckedDigest is the image digest from the last registry check
                  Used to detect when a new image version has been pushed with the same tag
                type: string
              lastRegistryCheckTime:
                description: LastRegistryCheckTime is when we last polled the registry
                  for image updates
                format: date-time
                type: string
              lastSuccessfulTime:
                description: LastSuccessfulTime is the last time a scan completed
                  successfully
                format: date-time
                type: string
              nextRegistryCheckTime:
                description: NextRegistryCheckTime is when the next registry poll
                  is scheduled
                format: date-time
                type: string
              observedGeneration:
                description: ObservedGeneration reflects the generation most recently
                  observed by the controller
                format: int64
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
