# Example: Using Secret References for Webhook URLs
#
# This example demonstrates how to securely store webhook URLs containing tokens
# in Kubernetes Secrets instead of storing them inline in the ImageScan resource.
#
# This is the recommended approach for production deployments where webhook URLs
# contain sensitive authentication tokens (e.g., Slack/Teams incoming webhook tokens).
#
# NOTE: The webhook URL and format are shared by both scanCompletion and statusChange
# notifications. Both will send to the same endpoint.

---
# Step 1: Create Secret containing the webhook URL
# Run: kubectl apply -f webhook-secret-reference.yaml
apiVersion: v1
kind: Secret
metadata:
  name: slack-webhook-secret
  namespace: invulnerable
type: Opaque
stringData:
  # The webhook URL with embedded token
  url: "https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX"

---
# Step 2: Reference the Secret in your ImageScan
apiVersion: invulnerable.io/v1alpha1
kind: ImageScan
metadata:
  name: nginx-scan-with-secret
  namespace: invulnerable
spec:
  image: docker.io/library/nginx:latest
  schedule: "0 2 * * *"  # Daily at 2 AM

  # Webhook configuration using Secret reference
  # URL and format are at top-level, shared by both notification types
  webhooks:
    # Reference the Secret for the webhook URL
    secretRef:
      name: slack-webhook-secret
      key: url  # Optional, defaults to "url"

    # Format applies to all notification types
    format: slack

    # Scan completion notifications
    scanCompletion:
      enabled: true
      minSeverity: High

    # Status change notifications
    statusChange:
      enabled: true
      minSeverity: High
      statusTransitions:
        - "active→fixed"
        - "active→ignored"

---
# Alternative: Multiple webhook URLs for different environments
apiVersion: v1
kind: Secret
metadata:
  name: webhook-urls
  namespace: invulnerable
type: Opaque
stringData:
  # Production Slack channel
  production-url: "https://hooks.slack.com/services/TPROD/BPROD/XXXXXXXXXX"
  # Staging Slack channel
  staging-url: "https://hooks.slack.com/services/TSTAG/BSTAG/XXXXXXXXXX"
  # Microsoft Teams webhook
  teams-url: "https://outlook.office.com/webhook/XXXXXXXXXX"

---
# Example: Using a specific key from the Secret
apiVersion: invulnerable.io/v1alpha1
kind: ImageScan
metadata:
  name: nginx-scan-production
  namespace: invulnerable
spec:
  image: docker.io/library/nginx:latest
  schedule: "0 2 * * *"

  webhooks:
    # Reference specific key from multi-URL secret
    secretRef:
      name: webhook-urls
      key: production-url  # Use production channel
    format: slack

    scanCompletion:
      enabled: true
      minSeverity: Critical  # Only critical for production

    statusChange:
      enabled: true
      minSeverity: Critical

---
# Creating Secrets using kubectl command line:
#
# For Slack:
#   kubectl create secret generic slack-webhook \
#     --from-literal=url='https://hooks.slack.com/services/YOUR/WEBHOOK/TOKEN' \
#     -n invulnerable
#
# For Microsoft Teams:
#   kubectl create secret generic teams-webhook \
#     --from-literal=url='https://outlook.office.com/webhook/YOUR/WEBHOOK/TOKEN' \
#     -n invulnerable
#
# From a file:
#   echo 'https://hooks.slack.com/services/YOUR/WEBHOOK/TOKEN' > webhook-url.txt
#   kubectl create secret generic slack-webhook \
#     --from-file=url=webhook-url.txt \
#     -n invulnerable
#   rm webhook-url.txt
#
# Security best practices:
#   1. Use Secrets for any webhook URLs containing tokens
#   2. Limit Secret access using RBAC (only controller needs read access)
#   3. Consider using external secret management (e.g., Vault, AWS Secrets Manager)
#   4. Rotate webhook tokens periodically and update Secrets
#   5. Use different webhook channels/endpoints for different environments
