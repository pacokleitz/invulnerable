apiVersion: invulnerable.io/v1alpha1
kind: ImageScan
metadata:
  name: web-dvwa-scan
  namespace: invulnerable
spec:
  # Container image to scan
  image: "vulnerables/web-dvwa:latest"

  # Scan schedule in cron format (daily at 2 AM)
  schedule: "*/5 * * * *"

  # TimeZone for the schedule (optional, e.g., "America/New_York", "Europe/Paris")
  # If not specified, uses the system timezone
  timeZone: "Europe/Paris"

  # SBOM format (cyclonedx or spdx)
  sbomFormat: "cyclonedx"

  # ==========================================
  # WEBHOOK NOTIFICATIONS
  # ==========================================
  #
  # Configure webhook notifications for scan completion and status changes.
  # Each notification type can have its own URL (e.g., different Slack channels).
  #
  # How to get webhook URLs:
  #   Slack: https://api.slack.com/messaging/webhooks
  #   Teams: https://learn.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/add-incoming-webhook
  #   Test: https://webhook.site or https://webhook.cool (for testing)
  #
  webhooks:
    # Scan completion notifications
    # Sent after each scan with vulnerability summary
    # NOTE: Only counts "actionable" vulnerabilities (excludes ignored/accepted CVEs)
    # If all detected CVEs are marked as ignored or accepted, no notification is sent
    scanCompletion:
      enabled: true
      url: https://merry-dolphin-15.webhook.cool
      format: slack  # or "teams"
      minSeverity: High  # Critical, High, Medium, Low, Negligible

      # Only notify for vulnerabilities with fixes available (optional)
      # When true, only CVEs with fixes will trigger notifications
      # Note: This is independent of spec.onlyFixed (which controls scanning)
      # You can scan all CVEs (spec.onlyFixed=false) but only notify for fixed ones
      # Default: true (only notify for fixed vulnerabilities)
      # To notify for ALL vulnerabilities including unfixed:
      # onlyFixed: false

    # Status change notifications
    # Sent when vulnerability statuses are changed via UI/API
    statusChange:
      enabled: true
      url: https://merry-dolphin-15.webhook.cool  # Can be different!
      format: slack  # or "teams"
      minSeverity: High  # Only notify for High+ severity

      # Only notify for vulnerabilities with fixes available (optional)
      # When true, only CVEs with fixes will trigger status change notifications
      # Note: This is independent of spec.onlyFixed (which controls scanning)
      # Default: true (only notify for fixed vulnerabilities)
      # To notify for ALL vulnerabilities including unfixed:
      # onlyFixed: false

      # Only notify for specific transitions (optional)
      # Format: "oldStatus→newStatus"
      # If not specified or empty, notifies on all transitions
      #
      # Common use cases:
      #   - Track fixes: ["active→fixed"]
      #   - Track triaged items: ["active→in_progress", "in_progress→fixed"]
      #   - Track all resolutions: ["active→fixed", "active→ignored", "active→accepted"]
      statusTransitions:
        - "active→fixed"      # Track when CVEs are patched
        - "active→ignored"    # Track when CVEs are triaged as non-issues
        - "in_progress→fixed" # Track remediation completion

      # Include note-only changes (default: false)
      # When true, notifies when only notes are updated without status change
      # When false, only notifies when status actually changes
      includeNoteChanges: false
  # ==========================================

  # Suspend scanning (set to true to pause)
  suspend: false

  # Job history limits
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3

  # Resource requests and limits
  resources:
    requests:
      memory: "256Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  # Workspace size for image extraction (uses node disk space via emptyDir)
  # Recommended sizes:
  #   - Small images (<2GB): 5Gi
  #   - Medium images (2-8GB): 10Gi (default)
  #   - Large images (8-20GB): 20Gi
  #   - Very large images (20GB+): 30Gi+
  #
  # ⚠️  WARNING: Node disk space consideration
  # Multiple ImageScans run concurrently and share node disk:
  #   Example: 5 ImageScans × 20Gi = 100Gi total node disk usage
  #
  # To prevent exhausting node disk:
  #   1. Monitor node disk capacity
  #   2. Use ResourceQuotas to limit total emptyDir usage
  #   3. Use nodeSelector to schedule scans on nodes with large disks
  #   4. Keep workspaceSize reasonable for your use case
  workspaceSize: "10Gi"

  # API endpoint (optional, auto-detected if not specified)
  # apiEndpoint: "http://invulnerable-backend.invulnerable.svc.cluster.local:8080"

  # Scanner image configuration (optional)
  scannerImage:
    repository: "invulnerable-scanner"
    tag: "latest"
    pullPolicy: "Always"  # Always pull to get latest local build

  # Private Registry Authentication (optional)
  #
  # To scan images from private Docker registries, create a docker-registry secret:
  #
  #   kubectl create secret docker-registry my-registry-secret \
  #     --docker-server=myregistry.example.com \
  #     --docker-username=myuser \
  #     --docker-password=mypassword \
  #     --docker-email=myemail@example.com \
  #     -n invulnerable
  #
  # Then reference the secret(s) here:
  # imagePullSecrets:
  #   - name: my-registry-secret

  # Filter unfixed vulnerabilities (optional)
  #
  # Only report vulnerabilities that have fixes available.
  # When enabled, Grype will skip CVEs with no known fix.
  #
  # Default: false (report all vulnerabilities)
  # onlyFixed: true
