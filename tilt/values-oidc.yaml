# Tilt local development with OIDC (using Dex)
# This extends values.yaml with OIDC-specific configuration

# Inherit from base values
# This file should be used with: tilt up -- --enable-oidc

# Use local registry
image:
  registry: "localhost:5001"

# Backend configuration
backend:
  replicaCount: 1

  # Frontend URL for webhook notifications (OIDC mode)
  frontendURL: "http://invulnerable.local:8080"

  database:
    host: "postgres-postgresql.invulnerable.svc.cluster.local"
    port: 5432
    user: "invulnerable"
    password: "invulnerable"
    name: "invulnerable"
    sslmode: "disable"

  # S3 storage for SBOM documents (using MinIO for local dev)
  s3:
    endpoint: "http://minio.invulnerable.svc.cluster.local:9000"
    bucket: "invulnerable"
    region: "us-east-1"
    accessKey: "minio"
    secretKey: "minio123"
    useSSL: false

  autoscaling:
    enabled: false
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# Frontend configuration
frontend:
  replicaCount: 1
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# Controller configuration
controller:
  replicaCount: 1
  rbac:
    clusterWide: false
  leaderElection:
    enabled: false
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# Scanner configuration
scanner:
  image:
    repository: "invulnerable-scanner"
    tag: "latest"

# OAuth2 Proxy - Configured for OIDC with Dex
oauth2Proxy:
  enabled: true
  replicaCount: 1

  # OIDC client credentials (must match Dex staticClients)
  clientID: "invulnerable-local"
  clientSecret: "dex-local-secret"
  cookieSecret: "0123456789abcdef0123456789abcdef"  # 32 chars

  config:
    # Use OIDC provider
    provider: "oidc"

    # Dex OIDC issuer - use external URL that browser can access
    oidcIssuerUrl: "http://dex.invulnerable.local:8080/dex"

    # Manually configure OIDC endpoints (skip discovery to avoid DNS issues)
    loginUrl: "http://dex.invulnerable.local:8080/dex/auth"
    redeemUrl: "http://dex.dex.svc.cluster.local:5556/dex/token"  # Internal URL for token exchange
    validateUrl: "http://dex.dex.svc.cluster.local:5556/dex/userinfo"  # Internal URL for validation
    jwksUrl: "http://dex.dex.svc.cluster.local:5556/dex/keys"  # Internal URL for JWKS

    # Redirect after OAuth login
    redirectUrl: "http://invulnerable.local:8080/oauth2/callback"

    # OIDC scopes
    scope: "openid profile email groups"

    # Allow all emails for local dev
    emailDomains:
      - "*"

    # Disable cookie security for HTTP (local dev only)
    cookieSecure: false
    cookieName: "_oauth2_proxy_oidc"

    # Skip provider button for faster login
    skipProviderButton: false  # Show login form

    # Extra args for OIDC
    extraArgs:
      - "--skip-auth-preflight=true"
      - "--reverse-proxy=true"
      - "--skip-oidc-discovery=true"  # Skip discovery, use manual endpoints
      - "--insecure-oidc-allow-unverified-email=true"  # For local testing
      - "--insecure-oidc-skip-issuer-verification=true"  # Allow issuer mismatch
      - "--pass-access-token=true"  # Forward access token to backend
      - "--pass-user-headers=true"  # Forward user info headers

  resources:
    requests:
      memory: "32Mi"
      cpu: "25m"
    limits:
      memory: "128Mi"
      cpu: "100m"

# Ingress configuration
ingress:
  enabled: true
  className: "nginx"

  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    # Do NOT use rewrite-target - it breaks /api and /oauth2 paths

  hosts:
    - host: invulnerable.local
      paths:
        - path: /api
          pathType: Prefix
          backend: backend
        - path: /
          pathType: Prefix
          backend: frontend

  # No TLS for local development
  tls: []

# Security contexts
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000
