# Task Commands Reference

This document provides a comprehensive reference for all available Task commands in the Invulnerable project.

## Quick Reference

```bash
# View all available tasks
task --list

# Get help for a specific task
task --summary <task-name>
```

## Build Commands

Build Docker images for deployment.

```bash
task build:backend       # Build backend Docker image
task build:frontend      # Build frontend Docker image
task build:scanner       # Build scanner Docker image
task build:all          # Build all images (runs in parallel)
```

## Deploy Commands

Deploy components to Kubernetes.

```bash
task deploy                         # Deploy all components with migrations
task deploy:namespace               # Create Kubernetes namespace
task deploy:postgres                # Deploy PostgreSQL StatefulSet
task deploy:migrations              # Run migrations as a Kubernetes Job
task deploy:backend                 # Deploy backend (standard)
task deploy:backend-with-migrations # Deploy backend with init container migrations
task deploy:frontend                # Deploy frontend
task deploy:ingress                 # Deploy ingress
task deploy:cronjob                 # Deploy vulnerability scanner CronJob
```

## Database Commands

Manage database migrations and access.

```bash
task db:migrate-up       # Run pending migrations
task db:migrate-down     # Rollback last migration
task db:port-forward     # Port-forward to PostgreSQL (localhost:5432)
```

**Note:** For `db:migrate-up` and `db:migrate-down`, you need to have `db:port-forward` running in another terminal.

## Logs Commands

Stream logs from running pods.

```bash
task logs:backend       # Stream backend pod logs
task logs:frontend      # Stream frontend pod logs
task logs:scanner       # Stream scanner CronJob logs
task logs:migration     # View migration job logs
```

## Port-Forward Commands

Forward ports from Kubernetes services to localhost.

```bash
task port-forward:backend   # Forward backend to localhost:8080
task port-forward:frontend  # Forward frontend to localhost:3000
task db:port-forward        # Forward PostgreSQL to localhost:5432
```

## Development Commands

Run services locally for development.

```bash
task dev:backend        # Run backend locally (requires local PostgreSQL)
task dev:frontend       # Run frontend dev server
```

**Environment Variables:**
- Backend connects to `localhost:5432` by default
- Use `task db:port-forward` to connect to Kubernetes PostgreSQL

## Utility Commands

Additional helpful commands.

```bash
task status              # Show deployment status (pods, services, jobs)
task validate:k8s        # Validate Kubernetes manifests (dry-run)
task clean               # Delete all Kubernetes resources (prompts for confirmation)
task clean:migrations    # Delete migration job only
task quickstart          # Build all images and deploy (one command)
```

## Common Workflows

### Initial Setup

```bash
# 1. Build and deploy everything
task quickstart

# 2. Check status
task status

# 3. View backend logs
task logs:backend
```

### Development Workflow

```bash
# Terminal 1: Port-forward PostgreSQL
task db:port-forward

# Terminal 2: Run backend
task dev:backend

# Terminal 3: Run frontend
task dev:frontend
```

### Production Deployment

```bash
# Build images
task build:all

# Deploy with automated migrations
task deploy

# Check deployment status
task status

# View logs if needed
task logs:backend
task logs:frontend
```

### Updating Migrations

```bash
# Option 1: Use Kubernetes Job
task deploy:migrations
task logs:migration

# Option 2: Manual (for development)
task db:port-forward  # Terminal 1
task db:migrate-up    # Terminal 2
```

### Troubleshooting

```bash
# Check overall status
task status

# Check specific pod logs
task logs:backend
task logs:frontend
task logs:migration

# Access services locally
task port-forward:backend
task port-forward:frontend

# Validate manifests
task validate:k8s

# Clean up and redeploy
task clean
task deploy
```

## Task Features

### Parallel Execution

Task automatically runs independent tasks in parallel:

```bash
task build:all  # Builds backend, frontend, and scanner in parallel
```

### Smart Caching

Tasks with `sources` defined only run when source files change:

```bash
task build:backend  # Only rebuilds if Go files changed
```

### Variables

Common variables are defined in `Taskfile.yml`:

- `NAMESPACE`: Kubernetes namespace (invulnerable)
- `BACKEND_IMAGE`: Backend Docker image name
- `FRONTEND_IMAGE`: Frontend Docker image name
- `SCANNER_IMAGE`: Scanner Docker image name
- `DB_*`: Database connection settings

### Dependencies

Tasks can have dependencies that run automatically:

```bash
task deploy:backend  # Automatically runs deploy:namespace first
```

## Configuration

### Taskfile Location

The main Taskfile is located at: `Taskfile.yml`

### Customizing Variables

You can override variables when running tasks:

```bash
task deploy NAMESPACE=my-custom-namespace
```

Or create a `Taskfile.override.yml`:

```yaml
version: '3'

vars:
  NAMESPACE: my-custom-namespace
  DB_PASSWORD: my-secure-password
```

## Tips

1. **Use tab completion**: Many shells support tab completion for Task
2. **Dry run**: Add `--dry` to see what a task would do without executing
3. **Verbose output**: Add `--verbose` or `-v` to see detailed execution
4. **Watch mode**: Some tasks support `--watch` to re-run on file changes
5. **List tasks**: Use `task --list` to see all available tasks
6. **Task summary**: Use `task --summary <task-name>` for task details

## Migrating from Make

If you're familiar with Make, here are the equivalent commands:

| Make Command | Task Command |
|--------------|--------------|
| `make build-all` | `task build:all` |
| `make deploy` | `task deploy` |
| `make deploy-backend` | `task deploy:backend` |
| `make db-migrate-up` | `task db:migrate-up` |
| `make logs-backend` | `task logs:backend` |
| `make clean` | `task clean` |
| `make help` | `task --list` |

## Further Reading

- [Task Documentation](https://taskfile.dev)
- [Task Installation Guide](https://taskfile.dev/installation/)
- [Task Usage Examples](https://taskfile.dev/usage/)
