-- Add updated_by tracking to vulnerabilities table
ALTER TABLE vulnerabilities
ADD COLUMN updated_by VARCHAR(255);

-- Create audit history table
CREATE TABLE IF NOT EXISTS vulnerability_history (
    id SERIAL PRIMARY KEY,
    vulnerability_id INTEGER NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,
    field_name VARCHAR(50) NOT NULL,
    old_value TEXT,
    new_value TEXT,
    changed_by VARCHAR(255),
    changed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    image_id INTEGER REFERENCES images(id) ON DELETE SET NULL,
    image_name VARCHAR(512)
);

CREATE INDEX idx_vulnerability_history_vuln_id ON vulnerability_history(vulnerability_id);
CREATE INDEX idx_vulnerability_history_changed_at ON vulnerability_history(changed_at DESC);

COMMENT ON TABLE vulnerability_history IS 'Audit trail for vulnerability status and metadata changes';
COMMENT ON COLUMN vulnerability_history.image_id IS 'Image context when change was made (nullable for global changes)';
COMMENT ON COLUMN vulnerability_history.image_name IS 'Denormalized image name for historical reference';
